<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/modalexcluir.css">
    <link rel="stylesheet" href="/css/modalatualizar.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet" />
    <title>Ficha Medica</title>
</head>

<body>
    <script>

        async function carregarPacientes() {
            try {
                const response = await fetch('/paciente/listar');
                if (!response.ok) {
                    throw new Error('Erro ao carregar os dados');
                }
                const pacientes = await response.json();

                const tabela = document.querySelector('.tabela .tbl tbody');
                tabela.innerHTML = '';

                // preenche a tabela com os dados de cada paciente
                pacientes.forEach(paciente => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="checkbox" class="checkbox" value="${paciente.id}"></td>
                        <td>
                            <div class="botoesin">
                                <button type="button" 
								        class="btneditarin" 
								        data-id="${paciente.id}" 
								        data-nome="${paciente.nome}" 
								        data-email="${paciente.email}" 
								        data-cpf="${paciente.cpf}" 
								        data-telefone="${paciente.telefone}"
                                        data-imagem="${paciente.nomeImagem}">
                                        <img src="/images/editar.svg" alt="Editar">
                                </button>
                                <button type="button" class="btndeletarin" data-id="${paciente.id}">
                                    <img src="/images/lixeira.svg" alt="Deletar">
                                </button>
                            </div>
                        </td>
                        <td>
                            <img src="${paciente.nomeImagem ? '/uploads/' + paciente.nomeImagem : '/uploads/user.png'}" 
     						alt="Foto do Paciente" style="width: 50px; height: 50px; border-radius: 5px">
                        </td>
                        <td>${paciente.id}</td>
                        <td>${paciente.nome}</td>
                        <td>${paciente.email}</td>
                        <td>${paciente.telefone}</td>
                        <td>${paciente.cpf}</td>
                    `;
                    tr.dataset.nome = paciente.nome.toLowerCase();
                    tabela.appendChild(tr);
                });
                const inputPesquisa = document.querySelector('input[type="search"]');
                inputPesquisa.addEventListener('input', function () {
                    const termoBusca = inputPesquisa.value.toLowerCase(); // obtem o termo de pesquisa em minúsculo
                    const pacientesNaTabela = tabela.querySelectorAll('tr'); // seleciona todas as linhas da tabela

                    pacientesNaTabela.forEach(linha => {
                        const nomePaciente = linha.dataset.nome; // pega o nome do paciente armazenado

                        if (nomePaciente.includes(termoBusca)) {
                            linha.style.display = '';
                        } else {
                            linha.style.display = 'none';
                        }
                    });
                });
            } catch (error) {
                console.error('Erro ao carregar os dados:', error);
            }
        }

        window.onload = carregarPacientes;
    </script>

    <div class="container">
        <header class="cabecalho">
            <img src="/images/logo.svg" alt="" />
            <h1>Ficha Médica</h1>
        </header>

        <div class="cadastrar">
            <h3>Criar Nova Ficha</h3>
            <form id="registerForm" class="pacienteForm" action="paciente/cadastrar" method="POST"
                enctype="multipart/form-data">
                <div class="preencher">
                    <div class="img">
                        <input type="file" id="fileInput" name="file" hidden />
                        <label for="fileInput" class="file-label">
                            <img id="previewImage" src="/images/imgperfil.svg" alt="Imagem de perfil"
                                style="width: 100px; height: 100px; border-radius: 5px;">
                        </label>
                        <p>Adicionar Imagem</p>
                    </div>

                    <div class="informacoes">
                        <label for="nome">Nome:</label>
                        <input type="text" id="nome" name="nome" placeholder="Cátia Silva" required pattern="^[a-zA-Zà-úÀ-Ú\s]+$"
                            title="O nome não pode conter números ou caracteres especiais." />

                            <label for="telefone">Telefone:</label>
                            <input type="tel" id="telefone" name="telefone" placeholder="(11) 12345-6789" required maxlength="15" title="O telefone deve conter 10 ou 11 dígitos e o DDD (exemplo: (11) 12345-6789)" />
                        
                            <label for="cpf">CPF:</label>
                            <input type="text" id="cpf" name="cpf" required maxlength="14" placeholder="000.000.000-00" title="O CPF deve conter exatamente 11 dígitos." />


                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" placeholder="catiasilva@gmail.com" />
                    </div>
                </div>

                <div class="btnbasic">
                    <button type="submit" id="cadastrar">Cadastrar</button>
                    <button type="reset" id="limpar">Limpar</button>
                </div>
            </form>
        </div>
        s
        <div class="exibir">
            <div class="funcionalidades">
                <form class="buscar">
                    <div class="input-container">
                        <input type="search" placeholder="Pesquisar Fichamento:">
                        <button type="submit">
                            <img src="/images/pesquisar.svg" alt="">
                        </button>
                    </div>
                </form>
            </div>
            <div class="botoes">

                <button type="button" class="btndeletar" id="btndeletar">
                    <img src="/images/lixeira.svg" alt="">
                </button>
            </div>


            <div id="modalConfirmacao" class="modal">
                <div class="modal-content">
                    <h2>Confirmar Exclusão</h2>
                    <p>Tem certeza de que deseja excluir este registro?</p>
                    <button id="confirmarExcluir" class="btn-confirmar">Excluir</button>
                    <button id="cancelarExcluir" class="btn-cancelar">Cancelar</button>
                </div>
            </div>
        </div>

        <div class="tabela">
            <table class="tbl">
                <thead>
                    <tr>
                        <th></th>
                        <th>Ações</th>
                        <th>Foto</th>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>CPF</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- dados dos pacientes serão preenchidos aqui via js -->
                </tbody>
            </table>


        </div>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const modal = document.getElementById('modalConfirmacao');
                const confirmarExcluir = document.getElementById('confirmarExcluir');
                const cancelarExcluir = document.getElementById('cancelarExcluir');
                let pacienteIdParaExcluir = null;


                function abrirModal(id) {
                    pacienteIdParaExcluir = id;
                    modal.style.display = 'block';
                }


                function fecharModal() {
                    modal.style.display = 'none';
                    pacienteIdParaExcluir = null;
                }

                // evento  clique para confirmar exclusão
                confirmarExcluir.addEventListener('click', async () => {
                    if (pacienteIdParaExcluir) {
                        try {
                            const response = await fetch(`/paciente/deletar/${pacienteIdParaExcluir}`, {
                                method: 'DELETE'
                            });
                            if (response.ok) {
                                alert('Registro excluído com sucesso');
                                carregarPacientes(); 
                            } else {
                                alert('Erro ao excluir o registro');
                            }
                        } catch (error) {
                            console.error('Erro:', error);
                        } finally {
                            fecharModal();
                        }
                    }
                });

                // evento de clique para cancelar exclusão
                cancelarExcluir.addEventListener('click', fecharModal);

                // detecta todos os botões de excluir e adiciona o evento de abrir modal
                document.addEventListener('click', (event) => {
                    if (event.target.closest('.btndeletarin')) {
                        const pacienteId = event.target.closest('.btndeletarin').getAttribute('data-id');
                        abrirModal(pacienteId);
                    }
                });
            });
        </script>

        <footer class="rodape">
            <div class="info">
                <p>Ajuda e suporte.</p>
                <p>Contato.</p>
                <p>Sobre nós.</p>
            </div>
        </footer>

        <div class="atualizar" id="atualizarConfirmacao">
            <div class="modal-content-atualizar">
                <h3>Atualizar Ficha</h3>
                <form id="updateForm" class="pacienteUpdateForm" action="/paciente/atualizar/${paciente.id}"
                    method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="_method" value="PUT" />
                    <div class="preencherUpdate">
                        <div class="img">
                            <input type="file" id="fileInputUpdate" name="file" hidden />
                            <label for="fileInputUpdate" class="file-label">
                                <img id="previewImageUpdate" src="/images/imgperfil.svg" alt="Imagem de perfil"
                                    style="width: 100px; height: 100px; border-radius: 5px;">
                            </label>
                            
                            <p>Atualizar Imagem</p>
                        </div>
                        <div class="informacoesUpdate">
                            <label for="nome">Nome:</label>
                            <input type="text" id="nomeUpdate" name="nome" placeholder="Cátia Silva" required pattern="^[a-zA-Zà-úÀ-Ú\s]+$"
                                title="O nome não pode conter números ou caracteres especiais." />

                                <label for="telefoneUpdate">Telefone:</label>
                                <input type="tel" id="telefoneUpdate" name="telefone" required maxlength="15" placeholder="(11) 12345-6789" title="O telefone deve conter 10 ou 11 dígitos e o DDD (exemplo: (11) 12345-6789)" />
                            
                                <label for="cpfUpdate">CPF:</label>
                                <input type="text" id="cpfUpdate" name="cpf" required maxlength="14" placeholder="000.000.000-00" title="O CPF deve conter exatamente 11 dígitos." />


                            <label for="email">Email:</label>
                            <input type="email" id="emailUpdate" name="email" placeholder="catiasilva@gmail.com" />
                        </div>
                    </div>

                    <div class="btnbasicUpdate">
                        <button type="submit" id="atualizarUpdate">Atualizar</button>
                        <button type="reset" id="cancelarUpdate">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('atualizarConfirmacao');
            let pacienteIdParaAtualizar = null;

            const fileInputUpdate = document.getElementById("fileInputUpdate");
            const previewImageUpdate = document.getElementById("previewImageUpdate");

            // fnção abrir a modal e exibir os dados
            function abrirModal(id, nome, telefone, cpf, email, imagem) {
                // preenche os campos do formulário
                document.getElementById('nomeUpdate').value = nome;
                document.getElementById('telefoneUpdate').value = telefone;
                document.getElementById('cpfUpdate').value = cpf;
                document.getElementById('emailUpdate').value = email;
                document.getElementById('')

                console.log(`Abrindo modal para o paciente com ID: ${id}, Nome: ${nome}`);
                pacienteIdParaAtualizar = id;

                // mostra a modal
                modal.style.display = 'block';

                // atualiza a ação do formulário
                const form = document.getElementById('updateForm');
                form.action = `/paciente/atualizar/${pacienteIdParaAtualizar}`;

                // atualiza a imagem de pré-visualização na modal
                if (imagem) {
                    previewImageUpdate.src = `/uploads/${imagem}`;
                } else {
                    previewImageUpdate.src = '/images/imgperfil.svg'; // Imagem padrão
                }
            }


            function fecharModal() {
                modal.style.display = 'none';
                pacienteIdParaAtualizar = null;

                // reseta a imagem de pré-visualização
                previewImageUpdate.src = '/images/imgperfil.svg';
            }

            // detecta mudanças no input de arquivo e atualiza a pré-visualização
            fileInputUpdate.addEventListener("change", function (event) {
                const file = event.target.files[0];

                if (file) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        previewImageUpdate.src = e.target.result;
                    };

                    reader.readAsDataURL(file);
                }
            });

            // detecta todos os botões de editar e adiciona o evento de abrir modal
            document.addEventListener('click', (event) => {
                const button = event.target.closest('.btneditarin');
                if (button) {
                    const id = button.getAttribute('data-id');
                    const nome = button.getAttribute('data-nome');
                    const telefone = button.getAttribute('data-telefone');
                    const cpf = button.getAttribute('data-cpf');
                    const email = button.getAttribute('data-email');
                    const imagem = button.getAttribute('data-imagem'); // Obtém a imagem do paciente



                    // chama a função com os valores extraídos
                    abrirModal(id, nome, telefone, cpf, email, imagem);
                    // botão para fechar a modal
                    document.getElementById('cancelarUpdate').addEventListener('click', fecharModal);

                    document.getElementById('updateForm').addEventListener('submit', async function (event) {
                        event.preventDefault(); // Previne o comportamento padrão de envio do formulário

                        const formData = new FormData(this);

                        try {
                            const response = await fetch(this.action, {
                                method: 'POST',
                                body: formData,
                            });

                            if (!response.ok) {
                                throw new Error(`Erro na requisição: ${response.statusText}`);
                            }

                            const data = await response.text();

                            alert("Ficha atualizada com sucesso!");
                            fecharModal(); // 
                            carregarPacientes(); 
                        } catch (error) {
                            console.error('Erro ao atualizar:', error);
                            alert("Erro ao atualizar a ficha. Tente novamente.");
                        }

                    });
                }
            });
        });
    </script>

    <script>
       document.getElementById('registerForm').addEventListener('submit', async function (event) {
    event.preventDefault(); // impede o envio padrão do formulário

    const formData = new FormData(this); // faz um objeto FormData a partir do formulário

    try {
        const response = await fetch('/paciente/cadastrar', {
            method: 'POST',
            body: formData, // envia o FormData (inclui arquivo e dados do formulário)
        });

        // Verifica se a resposta foi bem-sucedida
        if (!response.ok) {
            const errorMessage = await response.text(); // Recupera a mensagem de erro do backend
            throw new Error(errorMessage); // Lança um erro com a mensagem do backend
        }

        const result = await response.text();
        alert(result); // exibe a mensagem retornada do backend
        await carregarPacientes(); // recarrega a tabela para exibir os dados atualizados

    } catch (error) {
        console.error('Erro ao enviar o formulário:', error);
        alert('Houve um erro ao tentar cadastrar o paciente: ' + error.message); // Exibe o erro detalhado
    }
});

    </script>

    <!-- //delecao em massa -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const btndeletar = document.getElementById('btndeletar');

            if (btndeletar) {
                btndeletar.addEventListener('click', async () => {
                    // captura os IDs dos checkboxes selecionados
                    const selectedIds = Array.from(document.querySelectorAll('.checkbox:checked'))
                        .map(checkbox => checkbox.value);

                    console.log("IDs capturados:", selectedIds); // debug ids buscados

                    if (selectedIds.length === 0) {
                        alert('Nenhum paciente selecionado para deletar.');
                        return;
                    }

                    if (!confirm('Tem certeza de que deseja deletar os pacientes selecionados?')) {
                        return;
                    }

                    try {
                        const response = await fetch('/paciente/deletar-em-massa', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(selectedIds),
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao processar a requisição. Código: ' + response.status);
                        }

                        const data = await response.json();

                        if (data.message) {
                            alert(data.message);
                            if (data.message.includes("sucesso")) {
                                await carregarPacientes();
                            }
                        } else {
                            alert('Resposta inesperada do servidor.');
                        }
                    } catch (error) {
                        console.error('Erro ao processar a requisição:', error);
                        alert('Erro ao deletar os pacientes: ' + error.message);
                    }
                });
            } else {
                console.error("Botão de deletar não encontrado no DOM.");
            }
        });
    </script>


    <script>
        const fileInput = document.getElementById("fileInput");
        const resetButton = document.getElementById("limpar");
        const preview = document.getElementById("previewImage");

        document.getElementById("fileInput").addEventListener("change", function (event) {
            const file = event.target.files[0];
            const resetButton = document.getElementById("limpar");

            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    preview.src = e.target.result;
                };

                reader.readAsDataURL(file);
            }
        });

        resetButton.addEventListener("click", function () {
            preview.src = "images/imgperfil.svg";
        });
    </script>

    <!-- validacoes -->
     <script>
        document.addEventListener('DOMContentLoaded', () => {
    // Seleciona todos os campos de telefone e CPF no formulário de cadastro e atualização
    const telefoneInputs = document.querySelectorAll('#telefone, #telefoneUpdate');
    const cpfInputs = document.querySelectorAll('#cpf, #cpfUpdate');

    // Função para aplicar a máscara de telefone (DDD + número)
    telefoneInputs.forEach(telefoneInput => {
        telefoneInput.addEventListener('input', function () {
            let value = telefoneInput.value.replace(/\D/g, ''); // Remove tudo o que não é número
            if (value.length <= 11) {
                // Aplica a máscara para telefones com 10 ou 11 dígitos
                value = value.replace(/^(\d{2})(\d{1})(\d{4})(\d{4})$/, '($1) $2$3-$4'); // (XX) X XXXX-XXXX
                value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3'); // (XX) XXXXX-XXXX
            }
            telefoneInput.value = value;
        });
    });

    // Função para aplicar a máscara de CPF
    cpfInputs.forEach(cpfInput => {
        cpfInput.addEventListener('input', function () {
            let value = cpfInput.value.replace(/\D/g, ''); // Remove tudo o que não é número
            if (value.length <= 11) {
                // Aplica a máscara do CPF: 000.000.000-00
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
            }
            cpfInput.value = value;
        });
    });

    // Remover a máscara antes de enviar o formulário
    const forms = document.querySelectorAll('#cadastroForm, #atualizacaoForm'); // Seleciona os dois formulários
    forms.forEach(form => {
        form.addEventListener('submit', function (e) {
            // Remove a máscara de CPF e telefone antes de enviar
            telefoneInputs.forEach(input => {
                input.value = input.value.replace(/\D/g, ''); // Remove a máscara de telefone
            });
            cpfInputs.forEach(input => {
                input.value = input.value.replace(/\D/g, ''); // Remove a máscara de CPF
            });
        });
    });
});

     </script>
</body>

</html>